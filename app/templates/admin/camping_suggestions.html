{% extends "base.html" %}

{% block content %}
<div class="mb-8">
  <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">Sugerencias del Portal</h1>
  <p class="mt-2 text-slate-500">Gestiona el buzón de sugerencias enviado por los usuarios del sitio.</p>
</div>

<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-6">
  <form method="GET" class="flex items-center gap-3">
    <select name="status" class="select select-bordered">
      <option value="">Todos</option>
      <option value="nuevo" {% if status == 'nuevo' %}selected{% endif %}>Nuevas</option>
      <option value="revisado" {% if status == 'revisado' %}selected{% endif %}>Revisadas</option>
      <option value="archivado" {% if status == 'archivado' %}selected{% endif %}>Archivadas</option>
    </select>
    <button class="btn btn-primary">Filtrar</button>
    <a href="{{ url_for('admin.camping_suggestions') }}" class="btn btn-ghost">Limpiar</a>
  </form>
</div>

<div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="bg-slate-50">
      <tr>
        <th class="p-3 text-left">Fecha</th>
        <th class="p-3 text-left">Nombre</th>
        <th class="p-3 text-left">Email</th>
        <th class="p-3 text-left">Categoría</th>
        <th class="p-3 text-left">Mensaje</th>
        <th class="p-3 text-left">Idioma</th>
        <th class="p-3 text-left">Estado</th>
        <th class="p-3 text-left">Acción</th>
        <th class="p-3 text-left">Ver</th>
      </tr>
    </thead>
    <tbody>
      {% for item in suggestions %}
      <tr class="border-t border-slate-100 align-top hover:bg-slate-50 transition-colors">
        <td class="p-3 whitespace-nowrap text-slate-500">{{ item.created_at.strftime('%d/%m/%Y %H:%M') if item.created_at else '-' }}</td>
        <td class="p-3 font-medium text-slate-900">{{ item.name }}</td>
        <td class="p-3 text-slate-600">{{ item.email }}</td>
        <td class="p-3">
          <span class="px-2 py-1 rounded-full text-xs font-medium 
            {% if item.category == 'general' %}bg-blue-100 text-blue-700
            {% elif item.category == 'services' %}bg-purple-100 text-purple-700
            {% elif item.category == 'facilities' %}bg-amber-100 text-amber-700
            {% else %}bg-slate-100 text-slate-700{% endif %}">
            {{ item.category_label }}
          </span>
        </td>
        <td class="p-3 max-w-xs truncate text-slate-500">{{ item.message }}</td>
        <td class="p-3 text-center uppercase font-bold text-xs text-slate-400 font-mono">{{ item.lang }}</td>
        <td class="p-3 text-center">
          <span class="px-2 py-1 rounded text-[10px] font-bold uppercase 
            {% if item.status == 'nuevo' %}bg-sky-100 text-sky-700
            {% elif item.status == 'revisado' %}bg-emerald-100 text-emerald-700
            {% else %}bg-slate-200 text-slate-600{% endif %}">
            {{ item.status }}
          </span>
        </td>
        <td class="p-3">
          <form method="POST" action="{{ url_for('admin.update_camping_suggestion_status', suggestion_id=item.id, status=status or '') }}" class="flex items-center gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <select name="status" class="select select-bordered select-xs">
              <option value="nuevo" {% if item.status == 'nuevo' %}selected{% endif %}>Nuevo</option>
              <option value="revisado" {% if item.status == 'revisado' %}selected{% endif %}>Revisado</option>
              <option value="archivado" {% if item.status == 'archivado' %}selected{% endif %}>Archivado</option>
            </select>
            <button class="btn btn-xs btn-primary">Guardar</button>
          </form>
        </td>
        <td class="p-3 text-center">
          <button 
            type="button"
            data-modal-target="suggestion-modal"
            data-modal-toggle="suggestion-modal"
            onclick='viewSuggestion({{ item.to_dict()|tojson|safe }})'
            class="p-2 text-primary hover:bg-primary/10 rounded-lg transition-colors border-none bg-transparent"
            title="Ver detalles"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" class="p-6 text-center text-slate-400">Sin sugerencias.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal de Sugerencia (Flowbite) -->
<div id="suggestion-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-2xl max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-100 bg-slate-50/50">
                <div>
                    <h3 class="text-xl font-bold text-slate-900" id="modal_title">Detalles de la Sugerencia</h3>
                    <p class="text-sm text-slate-500" id="modal_date"></p>
                </div>
                <button type="button" class="text-slate-400 bg-transparent hover:bg-slate-200 hover:text-slate-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="suggestion-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Cerrar</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="p-8 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Usuario</label>
                        <p class="text-lg font-semibold text-slate-900" id="modal_name"></p>
                        <p class="text-primary font-medium" id="modal_email"></p>
                    </div>
                    <div class="flex flex-col items-start sm:items-end">
                        <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Categoría</label>
                        <span id="modal_category" class="mt-1 px-3 py-1 rounded-full text-xs font-bold"></span>
                        <div class="mt-3 flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-400 uppercase font-mono bg-slate-100 px-2 py-0.5 rounded" id="modal_lang"></span>
                            <span class="px-2 py-0.5 rounded text-xs font-bold" id="modal_status"></span>
                        </div>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <label class="text-xs font-bold uppercase tracking-wider text-slate-400 block mb-3">Mensaje</label>
                    <div class="bg-slate-50 rounded-2xl p-6 border border-slate-100 italic text-slate-700 leading-relaxed shadow-inner" id="modal_message">
                    </div>
                </div>
            </div>
            <!-- Modal footer -->
            <div class="flex items-center justify-end p-6 border-t border-slate-100 bg-slate-50/50">
                <button data-modal-hide="suggestion-modal" type="button" class="text-white bg-primary hover:bg-primary/90 focus:ring-4 focus:outline-none focus:ring-primary/30 font-bold rounded-xl text-sm px-8 py-3 text-center transition-all">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
  function viewSuggestion(item) {
    if (typeof item === 'string') item = JSON.parse(item);
    
    document.getElementById('modal_name').textContent = item.name;
    document.getElementById('modal_email').textContent = item.email;
    document.getElementById('modal_date').textContent = "Enviado el " + item.created_at;
    document.getElementById('modal_message').textContent = '"' + item.message + '"';
    document.getElementById('modal_lang').textContent = item.lang;
    
    const cat = document.getElementById('modal_category');
    cat.textContent = item.category_label;
    cat.className = "mt-1 px-3 py-1 rounded-full text-xs font-bold " + (
      item.category === 'general' ? 'bg-blue-100 text-blue-700' :
      item.category === 'services' ? 'bg-purple-100 text-purple-700' :
      item.category === 'facilities' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-700'
    );

    const statusBadge = document.getElementById('modal_status');
    statusBadge.textContent = item.status.toUpperCase();
    statusBadge.className = "px-2 py-0.5 rounded text-xs font-bold " + (
      item.status === 'nuevo' ? 'bg-sky-100 text-sky-700' :
      item.status === 'revisado' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'
    );
  }
</script>
{% endblock %}
